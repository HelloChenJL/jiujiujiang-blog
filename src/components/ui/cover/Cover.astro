---
import { blogLayoutConfig } from '@/config/blogLayoutConfig';
import { parseDate } from '@lib/datetime';
import { getLqipStyle } from '@lib/lqip';
import { getBackgroundImages } from '@lib/backgrounds';
import readingTime from 'reading-time';
import type { BlogPost } from '@/types/blog';
import WaveSvg from './wave';
import { MAX_WIDTH } from '@/constants/layout';

export interface CoverProps {
  data?: BlogPost;
  title?: string;
}

const { data, title } = Astro.props as CoverProps;

const { date, title: dataTitle, draft } = data?.data ?? {};

const readState = readingTime(data?.body ?? '');
const isDraft = import.meta.env.DEV && draft === true;

const backgroundImages = await getBackgroundImages();
const bannerSrc = backgroundImages.length
  ? backgroundImages[Math.floor(Math.random() * backgroundImages.length)]
  : blogLayoutConfig.banner.src;
const bannerLqipStyle = getLqipStyle(bannerSrc);
---

<div class="relative flex h-[60dvh] max-h-200 overflow-hidden">
  <div class="absolute inset-0 h-full bg-black/40"></div>
  <div class="absolute inset-0 bottom-[8dvh] flex flex-col items-center justify-center px-5 text-white">
    {
      title ? (
        <h1
          class={`shadow-text word-break flex items-center gap-2 text-center text-5xl/[1.2] font-bold tracking-widest ${MAX_WIDTH.content}`}
        >
          {title}
          <button
            type="button"
            title="复制链接"
            class="hover:text-primary cursor-pointer transition-colors duration-300"
            onclick="navigator.clipboard.writeText(window.location.href)"
            aria-label="复制链接"
          >
            <i class="fa-solid fa-link" aria-hidden="true"></i>
          </button>
        </h1>
      ) : data ? (
        <>
          <h1
            class={`shadow-text word-break text-4.5xl text-center font-bold md:text-2xl ${MAX_WIDTH.content} flex flex-wrap items-center justify-center gap-3`}
          >
            {dataTitle ?? title}
            {isDraft && (
              <span class="inline-flex items-center gap-1.5 rounded-full bg-yellow-500 px-3 py-1.5 text-base font-semibold text-white shadow-lg backdrop-blur-sm text-shadow-none hover:bg-yellow-500 md:px-2.5 md:py-1 md:text-sm">
                <i class="fa-solid fa-file-pen text-sm md:text-xs" aria-hidden="true"></i>
                草稿
              </span>
            )}
          </h1>
          {data && (
            <p class="mt-3 flex items-center justify-center gap-4 md:text-xs">
              <span class="flex items-center gap-1">
                <i class="fa-regular fa-calendar-days" aria-hidden="true"></i>
                发表于 {parseDate(date ?? '', 'YYYY-MM-DD')}
              </span>
              <span class="flex items-center gap-1">
                <i class="fa-solid fa-pen-nib" aria-hidden="true"></i> {readState?.words} 字
              </span>
              <span class="flex items-center gap-1">
                <i class="fa-regular fa-clock" aria-hidden="true"></i>
                {readState?.text}
              </span>
            </p>
          )}
        </>
      ) : (
        <>
          <h2 class="shadow-text font-chill-round text-5xl/[1.2]">{blogLayoutConfig?.alternate}</h2>
          <h1 class="shadow-text font-chill-round mt-3 text-5xl/[1.2] font-bold tracking-widest">
            {blogLayoutConfig?.title}
          </h1>
          <p class="shadow-text mt-5 text-sm">= {blogLayoutConfig?.subtitle} =</p>
        </>
      )
    }
  </div>
  <div
    class="relative -z-10 h-full min-h-60 w-full"
    transition:persist="page-cover-banner"
    id="banner-box"
    style={bannerLqipStyle}
  >
    <img
      src={bannerSrc}
      alt={blogLayoutConfig.banner.alt ?? 'cover'}
      class="h-full w-full object-cover"
      sizes="50vw"
    />
  </div>
  <WaveSvg />
</div>
